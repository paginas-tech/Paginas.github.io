<!-- PAGINA IMSS -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Derechohabiencia</title>
    
    <script src="/constancias/pizzip.min.js"></script>
    <script src="/constancias/docxtemplater.min.js"></script>
    <script src="/constancias/FileSaver.min.js"></script>
    
    <style>
        /* Estilo inicial del input */
        .custom-input {
            border: 1px solid gray;
            border-radius: 3px;
            outline: none; /* Quitar el contorno predeterminado */
            transition: box-shadow 0.3s ease, border-color 0.3s ease; /* Transición suave */
            width: 175px;
            height: 20px;
            text-transform: uppercase;
        }

        /* Cambiar el efecto al enfocar */
        .custom-input:focus {
            border-color: rgba(135, 206, 235, 0.7);
            box-shadow: 0 0 4px 1px rgba(135, 206, 235, 0.5); /* Contorno desvanecido */
            
        }
        /*Quiitar la x del search*/
        input[type="search"]::-webkit-search-cancel-button {
            display: none;
        }
        
        input::placeholder{
            text-transform: none;
        }
        clickable_boton{
            transition: transform 0s ease;
            cursor: pointer;
        }
        .clickable_boton:active{
            transform: scale(0.95);
        }
        /* Estilos para el botón de inicio de sesión */
        input[type="button"] {
            cursor: pointer;
        }
        input[type="button"]:hover {
            background-color: green; /* Cambio de color al pasar el mouse */
        }
    </style>
</head>

<body style="margin: 0px">
    
    <div style="background-color: rgb(86, 7, 12); margin: 0px;">
        <br>
        <img src="/constancias/logo_blanco.svg" alt="Gobierno de México" width="100px" height="30px">
        <br><br>
    </div>
    
    <div style="background-color: rgb(194,155,97); margin: 0px; padding: 10px; height: 40px">
        <h2 style="color: white; margin: 5px; padding: 5px">NO DERECHOHABIENCIA</h2>
    </div>
    
    <h2 style="margin: 10px">Solicitud de constancia de No derecho al servicio médico</h2>
    <hr>
   
   <button onclick="window.location.href='https://www.gob.mx/curp/'" style="padding: 7px; margin: 10px; background-color: rgb(86, 7, 12); border-color: rgb(86, 7, 12); color: white" class="clickable_boton">
  Consulta por CURP
</button>

<div style="background-color: rgba(135, 206, 235, 0.3); border: 2px solid rgb(135, 206, 235); outline: none; margin-left: 10px; margin-right: 20px; margin-top: 20px; padding: 7px; text-align: center; font-size: 17px">
    <span style="color: rgb(49, 112, 143)">Para realizar este trámite debes tener a la mano:</span>
    <span style="color: rgb(49, 112, 143)">
        <ul style="list-style-type: circle">
            <li style="text-align: left">CURP</li>
            <li style="text-align: left">Correo electrónico válido, el cual será asociado a tu CURP</li>
        </ul>
</span>
</div>
   
    <!-- PEDIR DATOS -->
    <div>   
    <form id="formulario" style="padding-left: 10px; padding-right: 10px"><br><br>
        
        <label for="curp">Curp:</label>
        <input maxlength="18" type="search" id="curp" class="custom-input" placeholder="CURP" required><br><br>
        
        <label for="a_paterno">Apellido paterno:</label>
        <input type="text" id="a_paterno" class="custom-input" placeholder="Apellido paterno" required><br><br>
        
        <label for="a_materno">Apellido materno:</label>
        <input type="text" id="a_materno" class="custom-input" placeholder="Apellido materno" required><br><br>
        
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" class="custom-input" placeholder="Nombre" required><br><br>
        
        <label for="fecha_nacimiento">Fecha de nacimiento:</label>
        <input type="text" id="fecha_nacimiento" class="custom-input" maxlength="10" required><br><br>
        
        <label for="sexo">Sexo:</label>
        <select id="sexo" required>
            <option value="" disabled selected>Seleccione</option>
            <option value="HOMBRE">Masculino</option>
            <option value="MUJER">Femenino</option>
        </select><br><br>
        
        <label for="lugar_nacimiento">Lugar de nacimiento:</label>
        <input type="text" id="lugar_nacimiento" class="custom-input" required><br><br>
        
        <button type="button" onclick="generarPDF()" style="background-color: white; color: rgb(86,7,12);  border-color: rgb(86, 7, 12); padding: 10px;">Tramitar constancia</button><br><br>
        
        <div style="background-color: rgba(135, 206, 235, 0.3); border: 2px solid rgb(135, 206, 235); outline: none; margin-left: 10px; margin-right: 10px; margin-top: 20px; padding: 10px; text-align: center; font-size: 17px; word-break: break-all">
    <span style="color: rgb(49, 112, 143);"><b>Aviso de privacidad simplificado</b></span><br>
    <span style="color: rgb(49, 112, 143)">La recolección de datos personales se lleva a cabo a través de la página electrónica</span>
    <a href="https://serviciosdigitales.imss.gob.mx/gestionAsegurados-web-externo/vigencia">https://serviciosdigitales.imss.gob.mx/gestionAsegurados-web-externo/vigencia</a>
    <span style="color: rgb(49, 112, 143)">cuyo administrador y responsable del tratamiento es la Coordinación de Clasificación de Empresas y Vigencia de Derechos del Instituto Mexicano del Seguro Social. Los datos personales que se recaban serán utilizados con la finalidad de generar y obtener la Constancia de vigencia de derechos para recibir servicio médico ante el IMSS con Homoclave IMSS-02-020-B. Si deseas conocer nuestro aviso de privacidad integral, lo podrás consultar en el portal:</span>
    <a href="https://serviciosdigitales.imss.gob.mx/gestionAsegurados-web-externo/avisoVigencia.jsp">https://serviciosdigitales.imss.gob.mx/gestionAsegurados-web-externo/avisoVigencia.jsp</a>
</div>
        
    </form>
    <br><br>
    </div>
    <!-- FIN PEDIR DATOS -->
    
    <!-- BIBLIOTECAS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.0.1/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.26.0/build/docxtemplater.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    -->
    <!-- FIN BIBLIOTECAS -->
    
    <script>
        //Enter en curp y completar campos
        var curpInput = document.getElementById('curp');
        curpInput.addEventListener('keydown', function(event){
                if(event.keyCode == 13){
                    completarCampos();
                }
        });
        
        function completarCampos(){
            let today = new Date();
            var idCurp = document.getElementById('curp').value.trim().toUpperCase();
            //Obtener dia mes y año
            var _a = idCurp.charAt(4)+idCurp.charAt(5);
            var _m = idCurp.charAt(6)+idCurp.charAt(7);
            var _d = idCurp.charAt(8)+idCurp.charAt(9);
            
            //Calcular año a partir de la CURP
            if(_a >= 00 && _a <= today.getFullYear()-2000){
                _a = ((today.getFullYear()-(today.getFullYear()-2000))/100) + _a;
            }else{
                _a = (((today.getFullYear()-(today.getFullYear()-2000))/100)-1) + _a;
            }
            
            document.getElementById('fecha_nacimiento').value = `${_d}/${_m}/${_a}`;
            
            //Calcular sexo a partir de la CURP
            var s = idCurp.charAt(10);
            var genero = document.getElementById('sexo');
            
            if(s === 'H'){
                genero.value = "HOMBRE";
            }else{
                genero.value = "MUJER";
            }
            
            var estado = ["AGUASCALIENTES","BAJA CALIFORNIA", "BAJA CALIFORNIA SUR", "CAMPECHE", "CHIAPAS", "CHIHUAHUA", "COAHUILA", "COLIMA", "DISTRITO FEDERAL", "DURANGO", "GUANAJUATO", "GUERRERO", "HIDALGO", "JALISCO", "MEXICO", "MICHOACAN", "MORELOS", "NAYARIT", "NUEVO LEON", "OAXACA", "PUEBLA", "QUERETARO", "QUINTANA ROO", "SAN LUIS POTOSI", "SINALOA", "SONORA", "TABASCO", "TAMAULIPAS", "TLAXCALA", "VERACRUZ", "YUCATAN", "ZACATECAS", "EXTRANJERO"];
            
            var ren = ["AS", "BC", "BS", "CC", "CS", "CH", "CL", "CM", "DF", "DG", "GT", "GR", "HG", "GC", "MC", "MN", "MS", "NT", "NL", "OC", "PL", "QO", "QR", "SP", "SL", "SR", "TC", "TS", "TL", "VZ", "YN", "ZS", "NE"];
        //Calcular estado apartir de la CURP
            var estN0 = idCurp.charAt(11)+idCurp.charAt(12);
            
            var ln;
            
            var estadoCurp = idCurp.substring(11, 13);
            var i = ren.indexOf(estadoCurp);
            
            if(ren.includes(estadoCurp)){
               ln = estadoCurp;
            }else{
                ln = "Error";
                alert("Curp no encontrada");
            }
            
            if(i !== -1){
                document.getElementById('lugar_nacimiento').value = estado[i];
                ln = estado[i];
            }else{
                document.getElementById('lugar_nacimiento').value = ln;
            }
            document.getElementById('a_paterno').focus();
        }
    
        async function generarPDF() {
            var curp = document.getElementById("curp").value.toUpperCase();
            const nombre = document.getElementById("nombre").value.toUpperCase();
            const a_paterno = document.getElementById("a_paterno").value.toUpperCase();
            const a_materno = document.getElementById("a_materno").value.toUpperCase();
            var oyMes = ["enero", "febrero","marzo","abril", "mayo","junio","julio","agosto","septiembre", "octubre","noviembre","diciembre"];
            
            var today = new Date();
            dia = String(today.getDate()).padStart(2, 0); // Día
            
           // Obtener el mes con un 0 inicial si es menor a 10
           
            let mesNum = today.getMonth() + 1; // Mes (getMonth devuelve un valor entre 0 y 11)
            mesNum = mesNum < 10 ? '0'+mesNum : mesNum; // Agrega un 0 si el mes es menor que 10
            
            const mesT = oyMes[mesNum-1];
            
            const año = today.getFullYear(); // Año
            const now = new Date();
            const year = now.getFullYear(); // Año actual

            const hours = String(now.getHours()).padStart(2, '0'); // Hora con 2 dígitos
            const minutes = String(now.getMinutes()).padStart(2, '0'); // Minutos con 2 dígitos
            const seconds = String(now.getSeconds()).padStart(2, '0'); // Segundos con 2 dígitos

            const hora = `${hours}:${minutes}:${seconds}`; // Formato de hora
            
            const sexo = document.getElementById("sexo").value.toUpperCase();
            const fecha_nacimiento = document.getElementById("fecha_nacimiento").value.toUpperCase();
            //Generar un numero aleatorio para el folio
            let num = Math.random()*(9999-1000+1)+1000;
            const folio = Math.trunc(num);
            
            var lugar_nacimiento = document.getElementById('lugar_nacimiento').value;

            if(document.getElementById('curp').value.length != 18){
                    alert("Curp incompleta");
                }else
            if (!curp || !nombre || !a_paterno || !a_materno) {
                alert("Por favor, completa todos los campos.");
                return;
            }

            try {
                const response = await fetch("/constancias/imss_constancia.docx");
                if (!response.ok) {
                throw new Error("No se pudo cargar la plantilla: " + response.statusText);
                }

                const content = await response.arrayBuffer();
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                // Insertar los valores del formulario en los marcadores
                doc.render({
                    curp: curp,
                    nombre: nombre,
                    a_paterno: a_paterno,
                    a_materno: a_materno,
                    dia: dia,
                    mesNum: mesNum,
                    mesT: mesT, // Sin transformación
                    año: año,
                    hora: hora,
                    sexo: sexo,
                    fecha_nacimiento: fecha_nacimiento,
                    folio: folio,
                    lugar_nacimiento: lugar_nacimiento,
                });

                // Generar el archivo modificado en formato .docx
                const modifiedContent = doc.getZip().generate({
                    type: "blob", // Tipo de archivo
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document", // MIME para DOCX
                });

                // Descargar el archivo
                const fileName0 = document.getElementById('curp').value;
                
                const fileName = "constancia_" + fileName0 + ".docx";
                saveAs(modifiedContent, fileName);
            } catch (error) {
                console.error("Error al generar el documento:", error);
                alert("Ocurrió un error al generar el documento. Revisa la consola.");
            }
        }
        
    </script>
</body>
  </html>
